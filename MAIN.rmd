---
title: "Project"
output: html_document
---

```{r include=FALSE}
# settings
knitr::opts_chunk$set(echo = TRUE)

```

קריאה לספריות העיקריות וקביעת סיד

```{r eval=TRUE, include=FALSE}
library(tidyverse)
#install.packages("gtrendsR")
library(gtrendsR)
#library("docstring")
source("project_utils.R")
set.seed(123)
```

```{=html}
<style>
    p  {direction: rtl;}
    h1 {text-align: center;}
    h2 {direction: rtl;}
    h4 {direction: rtl;}
    h3 {direction: rtl;text-decoration: underline;}
    ol {direction: rtl;}
    li {direction: rtl;}
</style>
```
::: {style="border-bottom:solid"}
:::

קריאה למאגרי נתונים שלנו

```{r getting data}
fmt <- "%Y-%m-%d"

data <- get_data() # the main dataset, contains ads info
rating <- get_rating_data() # contains rating info, e.g., ads cost, viewrs and etc
general <- get_general_data() # ads categories, e.g., beer, car and etc 
df <- read.csv("data\\trends_data.csv")
```

## תוצאות

### מבחן 1

בדיקה האם יש קשר בין השבוע עם היטס 100 לשבוע הסופרבול כלומר אנחנו בודקים אם יש קשר בין השבוע בשנה שהיו בו הכי הרבה חיפושים לשבוע הסופרבול

איך הגענו לטבלת השכיחות

```{r message=TRUE, warning=TRUE}
hits_on_sup <- filter(df, is_sup_week==TRUE)$hits
freq_table  <- df %>% group_by(is_peak=hits==100, is_sup_week) %>% summarise(count=n())
freq_table
```

בניית טבלת השכיחות וביצוע המבחן

```{r}
library("USP")

freq <- cbind(c(sum(hits_on_sup == 100), sum(hits_on_sup != 100)),
      c(sum(hits_not_on_sup == 100), sum(hits_not_on_sup != 100)))

freq
result <- USP.test(freq, B = 9999)
result$p.value
result$TestStat
```

### מבחן 2

מבחן על התוחלת של ההיטס בשבוע שבו הייתה פרסומת בסופרבול

```{r}
t.test(hits_on_sup, alternative = "greater", mu=85)
```

### מבחן 3

כאן אנחנו בודקים את הפרש התוחלות בין ההיטס בשבוע הסופרבול בין ההיטס בשבוע שהוא לא שבוע הסופרבול

```{r}
hits_not_on_sup <- filter(df, is_sup_week==FALSE)$hits
t.test(hits_on_sup, hits_not_on_sup, alternative = "greater", paired = FALSE, var.equal = 0, mu=25)
```

### מבחן 4

מגדם מזווג של ממוצע היטס בשנה של סופרבול ובשנה של לא סופרבול

```{r message=FALSE, warning=FALSE}

on_sup <- tibble(year=c(as.numeric(NA)),
               brand=c(as.character(NA)),
               hits=c(as.numeric(NA))) %>% na.omit()
not_sup <- tibble(year=c(as.numeric(NA)),
               brand=c(as.character(NA)),
               hits=c(as.numeric(NA))) %>% na.omit()

for (target_brand in brands$brand[-6]) 
  {
     
      sup_years <- year(search_dates(target_brand)$date)
      not_sup_years <- setdiff(2004:2020, year(search_dates(target_brand)$date))
      n <- min(length(sup_years), length(not_sup_years))
      
      
      means <- filter(df, brand==target_brand) %>% 
        group_by(brand, year=year(date)) %>%
        summarise(hits=mean(hits)) %>% ungroup()
      
      #on_sup <- on_sup %>% add_row(filter(means, year %in% sample(sup_years,n))) 
      #not_sup <- not_sup %>% add_row(filter(means, year %in% sample(not_sup_years,n)))
      for (i in 1:2)
      {
         on_sup <- on_sup %>% add_row(filter(means, year %in% sample(sup_years,n))) 
          not_sup <- not_sup %>% add_row(filter(means, year %in% sample(not_sup_years,n))) 
      }
  }

on_sup
not_sup
d <- sup$hits - not_sup$hits
qqnorm(d)
qqline(d)

t.test(on_sup$hits,not_sup$hits, paired = TRUE)

```

## נספחים-גרפים

```{r}
brands = unique(data['brand'])
brand_q <- data %>%
  group_by(brand) %>%
  summarise(count = n())

ggplot(data=brand_q, aes(x=brand, y=count))+
  geom_bar(stat = 'identity')

```

בדיקה על מותג מסוים בכל שנות הסופרבול

להוריד כנראה

```{r}

name <-  "Doritos"
dates <-  search_dates(brand)

# Without norm
by_month <- gtopics(name, "all") %>%
  group_by(month=month(date)) %>% 
  summarise(hits=mean(hits))

ggplot(by_month, aes(x=month,y=hits)) +
  geom_bar(stat="identity", position=position_dodge())+
 geom_text(aes(label=round(hits)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)



```

```{r}

# With norm 
by_month <- filter(df,brand==name) %>%
  group_by(month=month(date)) %>% 
  summarise(hits=mean(hits))

ggplot(by_month, aes(x=month,y=hits)) +
  geom_bar(stat="identity", position=position_dodge())+
 geom_text(aes(label=round(hits)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)

```

```{r}
by_week <- df %>% 
  group_by(is_sup_week, brand) %>% 
  summarise(hits=mean(hits))

by_week
ggplot(data=by_week, aes(x=brand, y=hits, fill=as.character(is_sup_week), width=0.8)) +
  geom_bar(stat="identity", position=position_dodge())+
  scale_fill_brewer(palette="Paired")+
  theme_minimal()
```

```{r}
by_month <- df %>% 
  group_by(brand, m=(month(date) == 2) & is_sup_year ) %>% 
  summarise(hits=mean(hits))

by_month
ggplot(data=by_month, aes(x=brand, y=hits, fill=m, width=0.8)) +
  geom_bar(stat="identity", position=position_dodge())+
  scale_fill_brewer(palette="Paired")
```

בדיקת תלות

```{r}

```

```{r}

```

```{r}
ads_cost <- sapply(data$year,
               function (y) { 
                 return(filter(rating,year==y)$cost_of_30_second_ad_usd)
               })

data <- data %>% mutate(cost= round(duration * (ads_cost / 30)))

```

```{r eval=FALSE, include=FALSE}
sample <- runif(100)

# Perform a one-sample t-test
t_test_result <- t.test(sample, mu = 0.5)

# Print the test result 1,23
print(t_test_result)
```

```{r eval=FALSE, include=FALSE}
#weeks_before_sup <- sapply(filter(df, is_sup_week)$date, function (d) {return(d - 7)})
week_before_sup <- filter(df, is_sup_week)$date - 7
weekk_after_sup <- filter(df, is_sup_week)$date + 7
```

```{r}

ad_count <- data %>%
  group_by(brand, year) %>%
  summarise(count = n(), cost=sum(cost))
ad_count$hits <- arrange(filter(df, is_sup_week == TRUE), brand)$hits
ad_count
```

```{r}
le_model <-  lm(data=ad_count, hits~count)
summary(le_model)
plot(le_model)
```

```{r}
n = 5000
samp_size <- 50
samples <- c()
for (i in 1:n) {samples[i] = mean(sample(df$hits, samp_size))}
hist(samples)
qqnorm(samples)
qqline(samples)
```

```{r}
#data <- read.csv("data\\superbowl-ads.csv")# %>%  filter(year > 2003)
#rating <-  read.csv("data\\super-bowl-ratings.csv")[-55,] %>% 
#    mutate(year=year(date), date=as.Date(date))



#t_e <- read.csv("data\\trends_data.csv")
#write.csv(df,"data\\trends_data.csv", row.names = FALSE)
#data <- read.csv("data\\superbowl-ads.csv")
#data <- data %>% select(-X)
#write.csv(data,"data\\superbowl-ads.csv", row.names = FALSE)
```

::: {style="border-bottom:solid"}
:::

<h1><u>נספחים</u></h1>

::: {.footnotes role="doc-endnotes"}
<ol>

<li>אתה לא חכם `r rev_fn()`</li>

</ol>
:::

<h1><u>רפרנסים</u></h1>
