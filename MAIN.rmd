---
title: "Project"
output: html_document
---

```{r include=FALSE}
# settings
knitr::opts_chunk$set(echo = TRUE)

```

קריאה לספריות העיקריות וקביעת סיד

```{r eval=TRUE, include=FALSE}
library(tidyverse)
#install.packages("gtrendsR")
library(gtrendsR)
#library("docstring")
source("project_utils.R")
SEED = 123
```

```{=html}
<style>
    p  {direction: rtl;}
    h1 {text-align: center;}
    h2 {direction: rtl;}
    h4 {direction: rtl;}
    h3 {direction: rtl;text-decoration: underline;}
    ol {direction: rtl;}
    li {direction: rtl;}
</style>
```
::: {style="border-bottom:solid"}
:::

קריאה למאגרי נתונים שלנו

```{r getting data}
fmt <- "%Y-%m-%d"

data <- get_data() # the main dataset, contains ads info
rating <- get_rating_data() # contains rating info, e.g., ads cost, viewrs and etc
general <- get_general_data() # ads categories, e.g., beer, car and etc 
df <- read.csv("data\\trends_data.csv")
```

## תוצאות

### מבחן 1

בדיקה האם יש קשר בין השבוע עם היטס 100 לשבוע הסופרבול כלומר אנחנו בודקים אם יש קשר בין השבוע בשנה שהיו בו הכי הרבה חיפושים לשבוע הסופרבול

איך הגענו לטבלת השכיחות

```{r message=TRUE, warning=TRUE}
hits_on_sup <- filter(df, is_sup_week==TRUE)$hits
freq_table  <- df %>% group_by(is_peak=hits==100, is_sup_week) %>% summarise(count=n())
freq_table
```

בניית טבלת השכיחות וביצוע המבחן

```{r}
library("USP")

freq <- cbind(c(sum(hits_on_sup == 100), sum(hits_on_sup != 100)),
      c(sum(hits_not_on_sup == 100), sum(hits_not_on_sup != 100)))

freq
result <- USP.test(freq, B = 9999)
result$p.value
result$TestStat
```

### מבחן 2

אנחנו מבצעים אמידה ברווח בר סמך לתוחלת של ההיטס בסופרבול ושל ההיטס לא בסופרבול

```{r}
set.seed(SEED)
t.test(hits_on_sup)$conf.int
t.test(sample(hits_not_on_sup, 100))$conf.int

samp <- sample(hits_not_on_sup, 100)
qqnorm(samp)
qqline(samp)
```

```{r}
week_before_sup <- as.Date(filter(df, is_sup_week)$date) - 7
week_after_sup <- as.Date(filter(df, is_sup_week)$date) + 7
before_sup <- df %>% filter(is_sup_year, date %in% week_before_sup)
after_sup <- df %>% filter(is_sup_year, date %in% week_after_sup)

t.test(hits_on_sup, alternative = "greater", mu=85)
t.test(after_sup$hits, before_sup$hits , alternative = "less", paired = T)

samp <- runif(length(hits_on_sup), min = min(hits_on_sup), max=100)

qqnorm(log(abs(hits_on_sup - before_sup$hits)+1))
qqline(log(abs(hits_on_sup - before_sup$hits)+1))
qqnorm(after_sup$hits - before_sup$hits)
qqline(after_sup$hits - before_sup$hits)


```

```{r}
df %>% filter(is_sup_year, date %in% week_before_sup)
t.test(hits_on_sup)
mean(hits_on_sup) - qt(0.975,113)*(sd(hits_on_sup)/sqrt(114))
mean(hits_on_sup) + qt(0.975,113)*(sd(hits_on_sup)/sqrt(114))
t.test(sample(hits_not_on_sup,500))
n <-  50
t_q <- qt(0.975,df=n-1)
samp <- sample(hits_on_sup, n)
se <-  sd(samp)/sqrt(n)
mean(samp) + 1.96*se
mean(samp) - 1.96*se
margin <- se*t_q
se
margin
mean(samp) + margin
mean(samp) - margin
t.test(samp)
```

### מבחן 2

כאן אנחנו בודקים את הפרש התוחלות בין ההיטס בשבוע הסופרבול בין ההיטס בשבוע שהוא לא שבוע הסופרבול

```{r}
set.seed(SEED)
hits_not_on_sup <- filter(df, is_sup_week==FALSE)$hits
samp <- sample(hits_not_on_sup, 300)
samp
t.test(hits_on_sup, samp, alternative = "greater", paired = FALSE, var.equal = 0, mu=0)
t.test(hits_on_sup, samp, alternative = "greater", paired = FALSE,var.equal = 0, mu=25)

d <- hits_on_sup - sample(hits_not_on_sup, 300)
qqnorm(d)
qqline(d)
n <- length(hits_on_sup- hits_not_on_sup)
m <- mean(hits_on_sup- hits_not_on_sup)
wilcox.test(d)

```

### מבחן 4

מבחן מזווג של ממוצע היטס בשנה שבו חברה כן פרסמה לעומת שבה היא לא פרסמה

נבנה דאטהפריימ מתאים

```{r}

on_sup <- tibble(year=c(as.numeric(NA)),
               brand=c(as.character(NA)),
               hits=c(as.numeric(NA))) %>% na.omit()

not_sup <- tibble(year=c(as.numeric(NA)),
               brand=c(as.character(NA)),
               hits=c(as.numeric(NA))) %>% na.omit()


for (target_brand in brands$brand) 
  {
     
      sup_years <- sort(year(search_dates(target_brand)$date), decreasing = T)
      not_sup_years <- sort(setdiff(2004:2020,year(search_dates(target_brand)$date)), decreasing = T)
      
      n <- min(length(sup_years), length(not_sup_years))
      means <- filter(df, brand==target_brand) %>% 
        group_by(brand, year=year(date)) %>%
        summarise(hits=mean(hits)) %>% ungroup()
      
      on_sup <- on_sup %>% add_row(means[sup_years[1:n]- 2004 + 1,]) 
      not_sup <- not_sup %>% add_row(means[not_sup_years[1:n] - 2004 + 1,])
     
      
}


```

מהתרשים ההפרשים בהתאם להנחות עבר שלנו (דגימות משנים קודמות בלתי תלויות) אפשר לראות כי ההפרשים מתפלגים בקירוב נורמלי והמבחן מזווג לא נדחה את השארת האפס

```{r message=FALSE, warning=FALSE}

d <- sup$hits - not_sup$hits
qqnorm(d)
qqline(d)

t.test(on_sup$hits,not_sup$hits, paired = TRUE)

```

## נספחים-גרפים

```{r}
brands = unique(data['brand'])
brand_q <- data %>%
  group_by(brand) %>%
  summarise(count = n())

ggplot(data=brand_q, aes(x=brand, y=count))+
  geom_bar(stat = 'identity')

```

בדיקה על מותג מסוים בכל שנות הסופרבול

להוריד כנראה

```{r}

name <-  "Doritos"
dates <-  search_dates(brand)

# Without norm
by_month <- gtopics(name, "all") %>%
  group_by(month=month(date)) %>% 
  summarise(hits=mean(hits))

ggplot(by_month, aes(x=month,y=hits)) +
  geom_bar(stat="identity", position=position_dodge())+
 geom_text(aes(label=round(hits)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)



```

```{r}

# With norm 
by_month <- filter(df,brand==name) %>%
  group_by(month=month(date)) %>% 
  summarise(hits=mean(hits))

ggplot(by_month, aes(x=month,y=hits)) +
  geom_bar(stat="identity", position=position_dodge())+
 geom_text(aes(label=round(hits)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)

```

```{r}
by_week <- df %>% 
  group_by(is_sup_week, brand) %>% 
  summarise(hits=mean(hits))

by_week
ggplot(data=by_week, aes(x=brand, y=hits, fill=as.character(is_sup_week), width=0.8)) +
  geom_bar(stat="identity", position=position_dodge())+
  scale_fill_brewer(palette="Paired")+
  theme_minimal()
```

```{r}
by_month <- df %>% 
  group_by(brand, m=(month(date) == 2) & is_sup_year ) %>% 
  summarise(hits=mean(hits))

by_month
ggplot(data=by_month, aes(x=brand, y=hits, fill=m, width=0.8)) +
  geom_bar(stat="identity", position=position_dodge())+
  scale_fill_brewer(palette="Paired")
```

```{r}

ad_count <- data %>%
  group_by(brand, year) %>%
  summarise(count = n(), cost=sum(cost))
ad_count$hits <- arrange(filter(df, is_sup_week == TRUE), brand)$hits
ad_count
```

```{r}
le_model <-  lm(data=ad_count, hits~count)
summary(le_model)
plot(le_model)
```

תרשים שאריות שמראים שהממוצע ההיטס אכן מתפלג נורמלית

```{r}
n = 5000
samp_size <- 50
samples <- c()
for (i in 1:n) {samples[i] = mean(sample(hits_on_sup, samp_size))}
hist(samples)
qqnorm(samples)
qqline(samples)
mean(samples)
```
